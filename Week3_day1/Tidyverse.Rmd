---
title: "Tidyverse"
output: html_notebook
---

```{r}
library(tidyverse)
library(CodeClanData)
```
```{r}
all_deaths
```
```{r}
#quick look at the dataset, first is rows, second is columns
dim(all_deaths)
```
```{r}
#check column names
names(all_deaths)
```

```{r}
#print first few top rows 
head(all_deaths, 3)
#bottom rows
tail(all_deaths, 3)
```
```{r}
#overview of data
glimpse(all_deaths)
view(all_deaths)
```
```{r}
#display unique 
unique(all_deaths$allegiances)
```

# Select function : keep or drop columns
```{r}
#select specific columns
deaths <- select(all_deaths, name, allegiances, year_of_death)
#select all columns but specifiied 
deaths <- select(all_deaths, -name)
deaths
```
```{r}
#select all colums starting with "book"
books <- select(all_deaths, starts_with("book"))
books
```

# Filter: select rows

```{r}
filtered <- filter(all_deaths, allegiances == "Lannister")

#multiple value filter

filtered <- filter(all_deaths, allegiances %in% c("Lannister", "House Lannister"))

filtered
```
## double filter
```{r}
males <- filter(all_deaths, allegiances == "None", gender == 0)
males
```
```{r}
less_than_299 <- filter(all_deaths, year_of_death <= 299)
less_than_299
```
```{r}
not_lan_fem <- filter(all_deaths, !allegiances %in% c("Lannister", "House Lannister"), gender == 0)
not_lan_fem
```

# arrange - arranges data
```{r}
arrange(all_deaths, desc(nobility))
```

# Mutate - create new / override columns
```{r}
death_years <- mutate(all_deaths,
                      years_survived = year_of_death - 298)
death_years
```
```{r}
mutate_all(death_years, as.logical)
```

# Summarise: summaries of tables

```{r}
#how many died in each family
deaths_grouped <- group_by(all_deaths, allegiances)
deaths_summarised <- summarise(deaths_grouped,
                               number_of_deaths = n())
deaths_summarised

```

# PIPES
## pipe operator is %>%
```{r}
death_pipe <- all_deaths %>% 
  select(name, allegiances, nobility, year_of_death) %>%
  mutate(years_survived = year_of_death - 298) %>%
  group_by(allegiances) %>%
  summarise(character_count = n()) %>%
  arrange(desc(character_count))

death_pipe
```

```{r}
glimpse(all_deaths)
```

```{r}
nobility_percentage <- all_deaths %>%
  filter(nobility == 1) %>%
  group_by(allegiances) %>%
  summarise(noble_count = n()) %>%
  mutate(nobility_percent = noble_count / sum(noble_count) * 100) %>%
  arrange(desc(nobility_percentage))

nobility_percentage
```
Load in the data, and have a look at it. How many variables does it have? How many observations? What are the variable names? What type of variables does it have?
```{r}
data_frame1 <- read_csv("03_dplyr_practice/data/state_income_data.csv")
glimpse(data_frame1)
data_frame1
```
Select the columns which contain the information from years 2002 to 2008. Ensure you keep the Index and State variables as well.
```{r}
years_extract <- data_frame1 %>%
  select("Index","State","Y2002", "Y2003", "Y2004", "Y2005", "Y2006", "Y2007", "Y2008")
years_extract
```

Rename the Index column to first_letter. Hint: look up the rename() function.
```{r}
rename_index_col <- data_frame1 %>%
  rename(first_letter = Index)

rename_index_col
```

Find the seven states which start with an A,B, or C

```{r}
abc_states <- rename_index_col %>%
  filter(first_letter %in% c("A", "B", "C"))
abc_states
```

Find which of these seven states have the greatest income in 2008.
```{r}
greatest_income_abc <- abc_states %>%
  arrange(desc(Y2008))
greatest_income_abc
```

Calculate the change in income for each state of these seven states (states starting with A,B, or C) between 2002 and 2008. Save the income change in a new column called income_change.
```{r}
income_change <- greatest_income_abc %>%
  mutate(income_change = (Y2008 - Y2002))
income_change
```
Find which of these seven states income change is greater than 500,000 (i.e. an increase of 500,000 or decrease of 500,000). - Alabama

Calculate the mean and median income change for all seven states.
```{r}
summarise(income_change, 
          income_change_mean = mean(income_change),
          income_change_median = median(income_change))
```

Go back to the original dataset which contains all states. Write a pipe which selects the State and Y2008 variables, arranges the income from highest to lowest, filters all those states which have a income of greater than 1 million, and then finally chooses the top 10 wealthiest states.










# Tidy Data

```{r}
# create subject info tibble
subject_hr <- tibble( name = c("SUBJ01","SUBJ02","SUBJ03"), 
  hr_am = c(68,72,68), 
  hr_pm = c(58,89,52))

messy_orders <- tibble( name = c("Joe Bloggs","Jane Smith","Penny Jones"), 
  order_info = c("XY7282/29-06-19","LO0182/15-03-19","AS6812/04-06-19"), 
  order_amount = c(58.00,125.00,75.25))

income <- tibble(religion = c("Agnostic","Atheist","Buddhist", "Catholic"), 
  X10k = c(12,25,3,75), 
  X10k_to_20k = c(34,14,6,60),
  X20k_to_30k = c(45,22,10,110))
```

# pivot_longer
```{r}
subject_hr
```
```{r}
hr_clean <- subject_hr %>%
  pivot_longer(cols = c("hr_am", "hr_pm"),
               names_to = "measurement_time", 
               values_to = "heart_rate")
hr_clean
```
```{r}
messy_orders
```
```{r}
tidy_orders <- messy_orders %>%
  separate(col = order_info,
           into = c("order_number", "order_date"),
           sep = "/")
tidy_orders
```

```{r}
income
```
```{r}
tidy_income <- income %>%
  rename("10k to 20k" = X10k_to_20k, "20k to 30k" = X20k_to_30k) %>%
  pivot_longer(cols = -religion,
               names_to = "income",
               values_to = "amount")
tidy_income
```



```{r}
hospital_visits <- read_csv("05_tidyr/data/hospitals93to98.csv")
hospital_visits
```
```{r}
#sort out years
hospital_long <- hospital_visits %>%
  pivot_longer(cols = starts_with("FY"),
               names_to = "year",
               values_to = "visit_numbers")
hospital_long
```
```{r}
hospitals_wide <- hospital_long %>%
  pivot_wider(names_from = Field,
              values_from = visit_numbers)
hospitals_wide
```
```{r}
hospital_visits_final <- hospitals_wide %>%
  separate(col = IcdChapter, 
           into = c("code", "description"),
           sep = "\\.")
hospital_visits_final
```
```{r}
#unite

united_test <- hospital_visits_final %>%
  unite(col = decease,
        c("code", "description"),
        sep = ";")
united_test
```


















